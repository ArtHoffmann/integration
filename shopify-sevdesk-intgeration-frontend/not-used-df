# Stage 1: Install dependencies
FROM node:18.15.0-bullseye-slim AS install
WORKDIR /app

# Ensure the correct registry is set
RUN npm config set registry https://registry.npmjs.org/

COPY ./sevdesk-shopify-integration/*.json ./
RUN npm install
# Install nx globally
RUN npm install -g nx

# Stage 2: Build the Angular application
FROM install as build
COPY . .
RUN nx run shopify-sevdesk:build

# Stage 3: Serve the Angular application with Nginx
FROM nginx:stable-alpine as production
COPY --from=build /app/dist/apps/shopify-sevdesk /usr/share/nginx/html
COPY ./nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
